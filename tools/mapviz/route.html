<!DOCTYPE html>
<html><head>
<meta charset="utf-8"/>
<title>MapViz Route view</title>
<!-- http://bl.ocks.org/mbostock/7341714 -->
<style>

.chart rect {
  fill: steelblue;
}
.chart .waypoint {
  stroke: blue;
}
.chart text {
  fill: black;
  font: 10px sans-serif;
  text-anchor: start;
}
.chart .position {
  stroke: green;
  stroke-linecap: round;
}
.chart .positionFrom {
  stroke: green;
  stroke-linecap: round;
}
.chart .position .gps {
  stroke: red;
  stroke-linecap: butt;
}
.chart .scene {
  stroke: red;
  stroke-linecap: round;
  fill-opacity: 0;
}
.axis path,
.axis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
    fill: black;
}
</style>
</head><body>
<p>Reading file as generated by mapvizlogs (use parameter f=...)</p>
<svg class="chart"></svg>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var width = 600,
    height = 600,
    padding = 50,
    height2 = 300;

var xScale = d3.scale.linear()
    .range([padding,width]);

var yScale = d3.scale.linear()
    .range([height2+height-padding, height2]);

var yScale2 = d3.scale.linear()
    .range([height2-padding, 0]);

var chart = d3.select(".chart")
    .attr("width", width)
    .attr("height", height+height2);

var filename = "out.json";
var urlParams = null;
function getParameter(p) {
  if (urlParams==null) {
    var pl     = /\+/g;  
    // Regex for replacing addition symbol with a space
    var search = /([^&=]+)=?([^&]*)/g;
    var decode = function(s) { return decodeURIComponent(s.replace(pl, " ")); }
    var query  = window.location.search.substring(1);

    urlParams = {};
    while (match = search.exec(query))
      urlParams[decode(match[1])] = decode(match[2]);
    return urlParams[p];
  }
}

var filename = getParameter("f");
if (!filename)
  filename = "out.json";
console.log("Reading file "+filename);

d3.json(filename, function(error, data) {
  if (error)  
    alert("Error reading file "+filename+": "+error);

  var tmax = Math.max( d3.max(data.positions, function(d) { return d.usertime; }), 
             d3.max(data.scenes, function(d) { return d.usertime; }) );
  xScale.domain([0,tmax]);
  yScale.domain(d3.extent(data.waypoints, function(d) { return d.totaldistanceAlong; }));
  yScale2.domain(d3.extent(data.positions, function(d) { return d.distanceFrom; }));

  var waypoints = chart.selectAll("g.waypoint")
      .data(data.waypoints)
    .enter().append("g")
      .classed('waypoint',true)
      .attr("transform", function(d, i) { return "translate(" + 0 + ", " + yScale(d.totaldistanceAlong) + ")"; });

  waypoints.append("line")
      .attr("x1", xScale(0) )
      .attr("y1", 0)
      .attr("x2", xScale(tmax) )
      .attr("y2", 0);
  waypoints.append("text")
      .attr("x", 0)
      .attr("y", 7)
      .text(function(d) { return d.name; });

  var positions = chart.selectAll("g.position")
      .data(data.positions)
    .enter().append("g")
      .classed('position',true)
      .attr("transform", function(d, i) { return "translate(" + xScale(d.usertime) + ", " + yScale(d.totaldistanceAlong) + ")"; });

  positions.append("line")
      .attr("x1", function(d,i) { return d.lastusertime ? xScale( d.lastusertime ) - xScale( d.usertime ) : 0; })
      .attr("y1", function(d,i) { return d.lasttotaldistanceAlong!==undefined ? yScale( d.lasttotaldistanceAlong ) - yScale( d.totaldistanceAlong ) : 0; })
      .attr("x2", 0)
      .attr("y2", 0);

  var scenes = chart.selectAll("g.scene")
      .data(data.scenes)
    .enter().append("g")
    .filter(function(d) { return d.position!==null && d.position!==undefined; })
      .classed('scene',true)
      .attr("transform", function(d, i) { return "translate(" + xScale(d.usertime) + ", " + yScale(d.position.totaldistanceAlong) + ")"; });

  var scenesize = 5;
  scenes
    .filter(function(d) { return d.name.indexOf('Start')!=0; })
    .append("circle")
      .attr("r", scenesize);
  scenes
    .filter(function(d) { return d.name.indexOf('Start')==0; })
    .append("polygon")
      .attr("points", "-5,0 0,5 5,0 0,-5");
  scenes.append("text")
      .attr("x", scenesize/2+2)
      .attr("y", -10)
      .text(function(d) { return d.name; });

  var positionsFrom = chart.selectAll("g.positionFrom")
      .data(data.positions)
    .enter().append("g")
      .classed('positionFrom',true)
      .attr("transform", function(d, i) { return "translate(" + xScale(d.usertime) + ", " + yScale2(d.distanceFrom) + ")"; });

  positionsFrom.append("line")
      .attr("x1", function(d,i) { return d.lastusertime ? xScale( d.lastusertime ) - xScale( d.usertime ) : 0; })
      .attr("y1", function(d,i) { return d.lastdistanceFrom!==undefined ? yScale2( d.lastdistanceFrom ) - yScale2( d.distanceFrom ) : 0; })
      .attr("x2", 0)
      .attr("y2", 0);

  var xAxis = d3.svg.axis()
                  .scale(xScale)
                  .orient("bottom");
  chart.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + (height2-padding) + ")")
      .call(xAxis);

  chart.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + (height2+height-padding) + ")")
      .call(xAxis);

  var yAxis = d3.svg.axis()
                  .scale(yScale)
                  .orient("left");
  chart.append("g")
      .attr("class", "axis")
      .attr("transform", "translate("+padding+",0)")
      .call(yAxis);

  var yAxis2 = d3.svg.axis()
                  .scale(yScale2)
                  .orient("left");
  chart.append("g")
      .attr("class", "axis")
      .attr("transform", "translate("+padding+",0)")
      .call(yAxis2);

});
</script>
</body></html>
