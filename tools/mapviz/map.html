<!DOCTYPE html>
<html><head>
<meta charset="utf-8"/>
<title>MapViz Map view</title>
<!-- http://bl.ocks.org/mbostock/7341714 -->
<style>

.chart rect {
  fill: steelblue;
}
.chart .waypoint {
  stroke: blue;
}
.chart text {
  fill: black;
  font: 10px sans-serif;
  text-anchor: start;
}
.chart .position {
  stroke: green;
  stroke-linecap: round;
}
.chart .position .gps {
  stroke: red;
  stroke-linecap: butt;
}
.chart .scene {
  stroke: red;
  stroke-linecap: round;
  fill-opacity: 0;
}
</style>
</head><body>
<p>Reading file as generated by mapvizlogs (use parameter f=...)</p>
<svg class="chart"></svg>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var width = 600,
    height = 600,
    padding = 20;

var xScale = d3.scale.linear()
    .range([padding,width-padding]);

var yScale = d3.scale.linear()
    .range([height-padding, padding]);

var chart = d3.select(".chart")
    .attr("width", width)
    .attr("height", height);

var filename = "out.json";
var urlParams = null;
function getParameter(p) {
  if (urlParams==null) {
    var pl     = /\+/g;  
    // Regex for replacing addition symbol with a space
    var search = /([^&=]+)=?([^&]*)/g;
    var decode = function(s) { return decodeURIComponent(s.replace(pl, " ")); }
    var query  = window.location.search.substring(1);

    urlParams = {};
    while (match = search.exec(query))
      urlParams[decode(match[1])] = decode(match[2]);
    return urlParams[p];
  }
}

var filename = getParameter("f");
if (!filename)
  filename = "out.json";
console.log("Reading file "+filename);

function rad_deg(ang) {
    return ang / (Math.PI/180.0)
}

var r_major = 6378137.000;
var r_minor = 6356752.3142;
var RATIO = r_minor / r_major;
var ECCENT = Math.sqrt(1.0 - (RATIO * RATIO));
var COM = 0.5 * ECCENT;

function xToLon(x) {
  return rad_deg(x) / r_major;
}
 
function yToLat(y) {
  var ts = Math.exp(-y / r_major);
  var phi = Math.PI / 2.0 - 2 * Math.atan(ts);
  var dphi = 1.0;
  var i = 0;
  while ((Math.abs(dphi) > 0.000000001) && (i < 15)) {
    con = ECCENT * Math.sin(phi);
    dphi = Math.PI/2 - 2 * Math.atan(ts * Math.pow((1.0 - con) / (1.0 + con), COM)) - phi;
    phi += dphi;
    i++;
  }
  return rad_deg(phi);
}

d3.json(filename, function(error, data) {
  if (error)  
    alert("Error reading file "+filename+": "+error);

  var xmin = d3.min(data.waypoints, function(d) { return d.x; });
  var ymin = d3.min(data.waypoints, function(d) { return d.y; });
  var xmax = d3.max(data.waypoints, function(d) { return d.x; });
  var ymax = d3.max(data.waypoints, function(d) { return d.y; });
  var range = Math.max(xmax-xmin,ymax-ymin);
  var xmid = (xmin+xmax)/2;
  var ymid = (ymin+ymax)/2;
  xScale.domain([xmid-range/2, xmid+range/2]);
  yScale.domain([ymid-range/2, ymid+range/2]);

  if (data.origin!==undefined) {
    console.log("origin "+data.origin.refx+","+data.origin.refy+" "+data.origin.metre);
    xmid = xmid/data.origin.metre+data.origin.refx;
    ymid = ymid/data.origin.metre+data.origin.refy;
    range = range/data.origin.metre;
  }
  var lat = yToLat(ymid);
  var lng = xToLon(xmid);
  //https://maps.googleapis.com/maps/api/staticmap?center=52.952949458071004,-1.1869821&size=550x550&zoom=15
  var zoom = Math.log(Math.PI*2*r_major/range)/Math.log(2);
  var izoom = Math.floor(zoom);
  var iscale = Math.pow(2, zoom-izoom);
  console.log("centre: "+lat+","+lng+" zoom="+(zoom)+" scale="+iscale+" (range "+range+")");

  chart.append("g")
    .attr("transform", "translate("+(width/2)+","+(height/2)+") scale("+iscale+","+iscale+") translate("+(-width/2)+","+(-height/2)+") ")
    .append("image")
      .attr("x", padding)
      .attr("y", padding)
      .attr("width", width-2*padding)
      .attr("height", height-2*padding)
      .attr("opacity", 0.3)
      .attr("xlink:href", "https://maps.googleapis.com/maps/api/staticmap?center="+lat+","+lng+"&size=512x512&zoom="+(izoom+1));

  var waypoints = chart.selectAll("g.waypoint")
      .data(data.waypoints)
    .enter().append("g")
      .classed('waypoint',true)
      .attr("transform", function(d, i) { return "translate(" + xScale(d.x) + ", " + yScale(d.y) + ")"; });

  var waypointsize = 10;
  waypoints.append("line")
      .attr("x1", -waypointsize/2)
      .attr("y1", -waypointsize/2)
      .attr("x2", waypointsize/2)
      .attr("y2", waypointsize/2);
  waypoints.append("line")
      .attr("x1", -waypointsize/2)
      .attr("y1", waypointsize/2)
      .attr("x2", waypointsize/2)
      .attr("y2", -waypointsize/2);
  waypoints.append("text")
      .attr("x", waypointsize/2+2)
      .attr("y", -10)
      .text(function(d) { return d.name; });

  var positions = chart.selectAll("g.position")
      .data(data.positions)
    .enter().append("g")
      .classed('position',true)
      .attr("transform", function(d, i) { return "translate(" + xScale(d.x) + ", " + yScale(d.y) + ")"; });

  if (false) {
    // show gps/kalman deltas
    positions.append("line")
        .classed('gps',true)
        .attr("x1", function(d,i) { return d.gpsx ? xScale( d.gpsx ) -xScale( d.x ) : 0; })
        .attr("y1", function(d,i) { return d.gpsy ? yScale( d.gpsy ) -yScale( d.y ) : 0; })
        .attr("x2", 0)
        .attr("y2", 0);
  }
  positions.append("line")
      .attr("x1", function(d,i) { return d.lastx ? xScale( d.lastx ) -xScale( d.x ) : 0; })
      .attr("y1", function(d,i) { return d.lasty ? yScale( d.lasty ) -yScale( d.y ) : 0; })
      .attr("x2", 0)
      .attr("y2", 0);

  var scenes = chart.selectAll("g.scene")
      .data(data.scenes)
    .enter().append("g")
    .filter(function(d) { return d.position!==null && d.position!==undefined; })
      .classed('scene',true)
      .attr("transform", function(d, i) { return "translate(" + xScale(d.position.x) + ", " + yScale(d.position.y) + ")"; });

  var scenesize = 5;
  scenes
    .filter(function(d) { return d.name.indexOf('Start')!=0; })
    .append("circle")
      .attr("r", scenesize);
  scenes
    .filter(function(d) { return d.name.indexOf('Start')==0; })
    .append("polygon")
      .attr("points", "-5,0 0,5 5,0 0,-5");
  scenes.append("text")
      .attr("x", scenesize/2+2)
      .attr("y", -10)
      .text(function(d) { return d.name; });

});
</script>
</body></html>
