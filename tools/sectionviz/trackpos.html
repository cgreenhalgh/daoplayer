<!DOCTYPE html>
<html><head>
<meta charset="utf-8"/>
<title>SectionViz trackpos view</title>
<!-- http://bl.ocks.org/mbostock/7341714 -->
<style>

.chart rect {
  fill: steelblue;
}
.chart text {
  fill: black;
  font: 10px sans-serif;
  text-anchor: start;
}
.axis path,
.axis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}
.selection .start {
    fill: none;
    stroke: green;
    shape-rendering: crispEdges;
}
.selection .end {
    fill: none;
    stroke: red;
    shape-rendering: crispEdges;
}
.section line {
  stroke: blue;
}

.section text {
    font-family: sans-serif;
    font-size: 11px;
    fill: black;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
    fill: black;
}
</style>
</head><body>
<p>Reading file as generated by log2sections (use parameter f=...)</p>
<svg class="chart"></svg>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var filename = "out.json";
var urlParams = null;
function getParameter(p) {
  if (urlParams==null) {
    var pl     = /\+/g;  
    // Regex for replacing addition symbol with a space
    var search = /([^&=]+)=?([^&]*)/g;
    var decode = function(s) { return decodeURIComponent(s.replace(pl, " ")); }
    var query  = window.location.search.substring(1);

    urlParams = {};
    while (match = search.exec(query))
      urlParams[decode(match[1])] = decode(match[2]);
    return urlParams[p];
  }
}

var filename = getParameter("f");
if (!filename)
  filename = "out.json";
console.log("Reading file "+filename);

d3.json(filename, function(error, data) {
  if (error)  
    alert("Error reading file "+filename+": "+error);

var width = 600,
    height = 600,
    padding = 50;

var xScale = d3.scale.linear()
    .range([padding,width-10]);

var yScale = d3.scale.linear()
    .range([height-padding,10]);

var chart = d3.select(".chart")
    .attr("width", width)
    .attr("height", height);

  var xrange = d3.extent(data.selections, function(d) { return d.totalTime; });
  var yrange = d3.extent(data.selections, function(d) { if (d.sections.length>0) { return d.sections[0].trackPos+d.currentSectionTime; } else return 0; });
  var maxrange = Math.max(xrange[1]-xrange[0],yrange[1]-yrange[0]);
  xScale.domain([xrange[0], xrange[0]+maxrange]);
  yScale.domain([yrange[0], yrange[0]+maxrange]);

  var colScale = d3.scale.linear()
    .range(["red","blue"]);
  colScale.domain([
    d3.min(data.selections, function(d) { return d3.min(d.sections, function(s) { return s.trackPos; }); }),
    d3.max(data.selections, function(d) { return d3.max(d.sections, function(s) { return s.trackPos; }); })
  ]);

  var sections = chart.selectAll("g.section")
     .data(data.track.sections) 
    .enter().append("g")
      .classed("section",true);

  sections.append("line")
      .attr("x1", padding)
      .attr("x2", width)
      .attr("y1", function(d) { return yScale( d.trackPos ); })
      .attr("y2", function(d) { return yScale( d.trackPos ); });
  sections.append("text")
    .attr("x",padding+3)
    .attr("y", function(d) { return yScale( d.trackPos )-3; })
    .text(function (d) { return d.name; });

  var selections = chart.selectAll("g.selection")
      .data(data.selections)
    .enter().append("g")
      .classed("selection", true);
  selections.append("line")
      .attr("stroke", function(d,i) { return colScale( d.sections[0].trackPos ); })
      .attr("x1", function(d) { return xScale( d.totalTime - d.currentSectionTime); } )
      .attr("x2", function(d) { return xScale( d.totalTime - d.currentSectionTime + d.sections[0].length); } )
      .attr("y1", function(d) { return yScale( d.sections[0].trackPos ); })
      .attr("y2", function(d) { return yScale( d.sections[0].trackPos+d.sections[0].length ); });


  var xAxis = d3.svg.axis()
                  .scale(xScale)
                  .orient("bottom");
  chart.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + (height-padding) + ")")
      .call(xAxis);

  var yAxis = d3.svg.axis()
                  .scale(yScale)
                  .orient("left");
  chart.append("g")
      .attr("class", "axis")
      .attr("transform", "translate("+padding+",0)")
      .call(yAxis);

});
</script>
</body></html>
